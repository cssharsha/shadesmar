# Trajectory Analysis Tools

This directory contains tools for analyzing and comparing SLAM trajectories from the bundle adjustment system.

## Tools Overview

### 1. `trajectory_compare` (C++)
Reads transform data from CSV files and keyframe data from MapStore to generate trajectory comparison data. Now also extracts odometry factors from the MapStore to build an additional trajectory based on the stored odometry constraints.

### 2. `plot_trajectory.py` (Python)
Visualizes trajectory comparison data with multiple plot types and filtering options for different trajectory sources.

## Data Sources

The tool now compares **four trajectory sources**:

1. **Keyframes** - Ground truth poses from the SLAM system
2. **TF Transforms** - Robot-based relative transforms from TF tree
3. **Essential Transforms** - Visual odometry-based relative transforms
4. **Odometry Factors** - Relative transforms stored as GTSAM factors in MapStore

## Usage

### Step 1: Build the Tools
```bash
# Build C++ trajectory comparison tool
bazel build //scripts:trajectory_compare

# Build Python plotting tool (optional, can run directly)
bazel build //scripts:plot_trajectory
```

### Step 2: Generate Trajectory Comparison Data
```bash
# Run with default paths
./bazel-bin/scripts/trajectory_compare

# Or specify custom paths
./bazel-bin/scripts/trajectory_compare [csv_path] [map_base_path] [output_path]
```

**Default paths:**
- CSV input: `/data/robot/reconstruct.csv`
- Map data: `/data/robots` (robot.dat, robot.idx, robot.meta)
- Output: `/data/robot/trajectory_comparison.csv`

### Step 3: Visualize Results
```bash
# Show plots interactively
python3 scripts/plot_trajectory.py /data/robot/trajectory_comparison.csv --show

# Save plots to files
python3 scripts/plot_trajectory.py /data/robot/trajectory_comparison.csv --output /data/robot/plots

# Save as PDF
python3 scripts/plot_trajectory.py /data/robot/trajectory_comparison.csv --output /data/robot/plots --format pdf

# Show only keyframe trajectory
python3 scripts/plot_trajectory.py /data/robot/trajectory_comparison.csv --keyframes-only --show

# Show only TF transform trajectory
python3 scripts/plot_trajectory.py /data/robot/trajectory_comparison.csv --tf-only --show

# Show only Essential matrix transforms
python3 scripts/plot_trajectory.py /data/robot/trajectory_comparison.csv --essential-only --show

# Show only odometry factors trajectory
python3 scripts/plot_trajectory.py /data/robot/trajectory_comparison.csv --odometry-only --show

# Hide keyframes, show only transforms
python3 scripts/plot_trajectory.py /data/robot/trajectory_comparison.csv --hide-keyframes --show

# Hide TF transforms, show keyframes and Essential transforms
python3 scripts/plot_trajectory.py /data/robot/trajectory_comparison.csv --hide-tf --show

# Compare odometry factors vs keyframes only
python3 scripts/plot_trajectory.py /data/robot/trajectory_comparison.csv --hide-transforms --show
```

## Trajectory Filtering Options

The plotting tool supports several filtering options to focus on specific trajectory types:

### Exclusive Filters (Show Only One Type)
- `--keyframes-only` - Show only the keyframe trajectory
- `--transforms-only` - Show only transform trajectories (both TF and Essential)
- `--tf-only` - Show only TF transform trajectory
- `--essential-only` - Show only Essential matrix transform trajectory
- `--odometry-only` - Show only odometry factors trajectory

### Inclusive Filters (Hide Specific Types)
- `--hide-keyframes` - Hide keyframe trajectory
- `--hide-transforms` - Hide all transform trajectories
- `--hide-tf` - Hide TF transform trajectory
- `--hide-essential` - Hide Essential matrix transform trajectory
- `--hide-odometry` - Hide odometry factors trajectory

### Filter Examples
```bash
# Compare only TF vs Essential transforms (no keyframes)
python3 scripts/plot_trajectory.py data.csv --hide-keyframes --show

# Focus on TF transform accuracy
python3 scripts/plot_trajectory.py data.csv --tf-only --show

# Analyze keyframe trajectory only
python3 scripts/plot_trajectory.py data.csv --keyframes-only --show

# Compare odometry factors vs ground truth
python3 scripts/plot_trajectory.py data.csv --hide-transforms --show

# Show everything except odometry factors
python3 scripts/plot_trajectory.py data.csv --hide-odometry --show
```

## Input Data Formats

### CSV Transform Data (`reconstruct.csv`)
Generated by the reconstruction system with format:
```
x,y,z,r,p,y,kf1_id,kf2_id,method
0.001,0.002,0.003,0.01,0.02,0.03,71,72,TF
...
```

### MapStore Data
Binary files containing keyframe poses, factors, and map data:
- `robot.dat` - Main data file
- `robot.idx` - Index file
- `robot.meta` - Metadata file

**Factor Types Extracted:**
- **ODOMETRY factors** - Relative pose constraints between consecutive keyframes
- **PRIOR factors** - Absolute pose anchors
- **LOOP_CLOSURE factors** - Loop closure constraints
- **IMU_PREINTEGRATED factors** - IMU-based constraints

## Output Data

### Trajectory Comparison CSV
Combined data with format:
```
type,id,x,y,z,roll,pitch,yaw,timestamp,method
keyframe,71,0.008,0.059,-0.089,0.004,-0.007,-0.998,1234567890.123,ground_truth
transform,72,0.001,0.002,0.003,0.01,0.02,0.03,0,TF
odometry,72,0.001,0.002,0.003,0.01,0.02,0.03,1234567891.123,odometry_factors
...
```

**Data Types:**
- `keyframe` - Ground truth poses from SLAM system
- `transform` - Cumulative trajectory from reconstruction CSV
- `odometry` - Cumulative trajectory from odometry factors

## Generated Plots

1. **2D Trajectory Comparison** - X-Y and X-Z plane views
2. **3D Trajectory Visualization** - Full 3D trajectory paths
3. **Orientation Comparison** - Roll, pitch, yaw over time
4. **Transform Statistics** - Step sizes, method distribution, cumulative distance

**Visual Legend:**
- **Blue circles** (●) - Keyframes (ground truth)
- **Red squares** (■) - TF Transforms
- **Green triangles** (▲) - Essential Matrix Transforms
- **Magenta diamonds** (♦) - Odometry Factors

## Statistics Output

The C++ tool prints comprehensive statistics:
- **Keyframe trajectory**: Total distance, displacement, duration
- **Transform trajectory**: Method breakdown, step sizes, accuracy
- **Odometry trajectory**: Factor-based trajectory analysis
- **Comparison metrics**: Position error, relative error percentage between all sources

### Sample Statistics Output:
```
=== TRAJECTORY COMPARISON STATISTICS ===

KEYFRAME TRAJECTORY:
  Total keyframes: 50
  Start position: [0.000, 0.000, 0.000]
  End position: [2.150, -0.350, 0.120]
  Total displacement: 2.178 meters
  Duration: 25.5s

ODOMETRY TRAJECTORY:
  Total odometry points: 50
  Start position: [0.000, 0.000, 0.000]
  End position: [2.098, -0.385, 0.098]
  Total displacement: 2.142 meters

ODOMETRY vs KEYFRAMES COMPARISON:
  Position error: 0.063 meters
  Relative error: 2.89%
```

## Example Workflow

```bash
# 1. Ensure your SLAM system has generated the required data files
ls /data/robot/reconstruct.csv
ls /data/robots.dat

# 2. Run trajectory comparison
./bazel-bin/scripts/trajectory_compare

# 3. Generate plots
python3 scripts/plot_trajectory.py /data/robot/trajectory_comparison.csv --show

# 4. Save publication-quality plots
python3 scripts/plot_trajectory.py /data/robot/trajectory_comparison.csv \
    --output /data/robot/analysis --format pdf
```

## Dependencies

### C++ Tool
- Core storage and types libraries
- Google Logging (glog)
- Eigen3 (for matrix operations)

### Python Tool
- pandas (data manipulation)
- matplotlib (plotting)
- numpy (numerical operations)

## Troubleshooting

### Common Issues

1. **File not found errors**: Ensure paths are correct and files exist
2. **Empty CSV**: Check that reconstruction system is writing transform data
3. **MapStore load failure**: Verify robot.dat and associated files are valid
4. **Python import errors**: Install required packages: `pip install pandas matplotlib numpy`

### Debug Tips

- Use `--verbose` flag with trajectory_compare for detailed logging
- Check file permissions on data directories
- Verify CSV format matches expected structure
- Ensure sufficient disk space for output files